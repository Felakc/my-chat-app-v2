<!DOCTYPE html>
<html>
<head>
    <title>My Private Chat</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        #auth-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        
        /* Боковая панель */
        #sidebar { width: 250px; background: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.3s; }
        .user-item:hover { background: #e7f3ff; }
        .user-item.active { background: #0084ff; color: white; }

        /* Окно чата */
        #main-chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
        .msg.me { align-self: flex-end; background: #0084ff; color: white; }
        .msg.other { align-self: flex-start; background: #e4e6eb; color: black; }
        
        #input-area { padding: 20px; background: white; display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h2>Вход в чат</h2>
        <input type="text" id="u-name" placeholder="Никнейм"><br>
        <input type="password" id="u-pass" placeholder="Пароль"><br>
        <div>
            <button onclick="auth('login')">Войти</button>
            <button onclick="auth('register')" style="background: #42b72a;">Регистрация</button>
        </div>
        <p id="auth-error" style="color: red;"></p>
    </div>

    <div id="sidebar">
        <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #ddd;">Контакты</div>
        <div id="user-list"></div>
    </div>

    <div id="main-chat">
        <div id="chat-header" style="padding: 15px; background: white; border-bottom: 1px solid #ddd;">Выберите чат</div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="m-input" placeholder="Сообщение..." style="flex: 1;">
            <button onclick="send()">Отправить</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = '';
        let currentRoom = '';

        async function auth(type) {
            const username = document.getElementById('u-name').value;
            const password = document.getElementById('u-pass').value;
            const res = await fetch('/' + type, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                myName = username;
                document.getElementById('auth-screen').style.display = 'none';
                loadUsers();
            } else {
                document.getElementById('auth-error').innerText = 'Ошибка!';
            }
        }

        async function loadUsers() {
            const res = await fetch('/users');
            const users = await res.json();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            users.forEach(user => {
                if (user.username === myName) return;
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerText = user.username;
                div.onclick = () => selectUser(user.username, div);
                list.appendChild(div);
            });
        }

        function selectUser(targetUser, element) {
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            currentRoom = [myName, targetUser].sort().join('_');
            document.getElementById('chat-header').innerText = 'Чат с ' + targetUser;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join room', currentRoom);
        }

        function send() {
            const msg = document.getElementById('m-input').value;
            if (!msg || !currentRoom) return;
            socket.emit('chat message', { room: currentRoom, msg, sender: myName });
            document.getElementById('m-input').value = '';
        }

        socket.on('chat message', (data) => {
            const div = document.createElement('div');
            div.className = 'msg ' + (data.sender === myName ? 'me' : 'other');
            div.innerText = data.msg;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 100000;
        });

        socket.on('chat history', (history) => {
            history.forEach(data => {
                const div = document.createElement('div');
                div.className = 'msg ' + (data.username === myName ? 'me' : 'other');
                div.innerText = data.text;
                document.getElementById('messages').appendChild(div);
            });
            document.getElementById('messages').scrollTop = 100000;
        });
    </script>
</body>
</html>