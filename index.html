<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Chat App (Secure)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        body { margin: 0; padding-bottom: 3rem; font-family: sans-serif; }
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages li { padding: 0.5rem 1rem; }
        #messages li:nth-child(odd) { background: #efefef; }
        #chat { background: #333; padding: 0.25rem; display: flex; box-sizing: border-box; }
        #chat > input, #chat > button { border: none; padding: 0.5rem; margin: 0.25rem; }
        #chat > input:focus { outline: none; }
        #chat > button { background: #1a73e8; color: white; }
        .hidden { display: none; }
        #auth-form { padding: 20px; border: 1px solid #ccc; max-width: 400px; margin: 50px auto; text-align: center; }
        #auth-form input { margin: 10px 0; padding: 10px; width: 80%; display: block; margin-left: auto; margin-right: auto; }
        #auth-form button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #messages img { max-width: 100%; height: auto; border-radius: 5px; margin-top: 5px; } 
    </style>
</head>
<body>
    <ul id="messages"></ul>

    <form id="auth-form" action="">
        <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input id="auth-username" autocomplete="off" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required />
        <input id="auth-password" type="password" autocomplete="off" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <button id="register-btn" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="login-btn" type="submit">–í–æ–π—Ç–∏</button>
        <p id="auth-message" style="color: red;"></p>
    </form>

    <form id="chat" action="" class="hidden">
        <input id="username" autocomplete="off" placeholder="–í–∞—à–µ –ò–º—è" style="width: 100px;" readonly />
        <input id="receiver" autocomplete="off" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–¥–ª—è –õ–°)" style="width: 150px;" />
        
        <input type="file" id="file-input" accept="image/*" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É" style="width: 80px; padding: 0;">
        
        <input id="m" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex-grow: 1;" />
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    
    <script src="/socket.io/socket.io.js"></script> 
    
    <script>
        // üö®üö®üö® –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ù–û–í–´–ô URL –°–ï–†–í–ò–°–ê RENDER üö®üö®üö®
        // –ü–†–ò–ú–ï–†: 'https://my-chat-app-v2-uzje.onrender.com'
        const SERVER_URL = 'https://my-chat-app-v2-uzje.onrender.com'; 
        
        const socket = io(SERVER_URL, {
            transports: ['websocket'] 
        }); 

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —á–∞—Ç–∞... (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏)

        const authForm = document.getElementById('auth-form');
        const authUsernameInput = document.getElementById('auth-username');
        const authPasswordInput = document.getElementById('auth-password');
        const registerBtn = document.getElementById('register-btn');
        const authMessage = document.getElementById('auth-message');
        const chatForm = document.getElementById('chat');
        const inputMessage = document.getElementById('m');
        const inputReceiver = document.getElementById('receiver'); 
        const inputChatUsername = document.getElementById('username'); 
        const fileInput = document.getElementById('file-input'); 
        const messages = document.getElementById('messages');

        let currentUsername = null; 
        
        // --- –õ–æ–≥–∏–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
        
        registerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const username = authUsernameInput.value.trim();
            const password = authPasswordInput.value;
            if (username && password) {
                socket.emit('register', { username, password });
            }
        });

        authForm.addEventListener('submit', function(e) {
            e.preventDefault(); // <-- –ì–õ–ê–í–ù–û–ï: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const username = authUsernameInput.value.trim();
            const password = authPasswordInput.value;
            
            if (e.submitter && e.submitter.id === 'register-btn') return;
            
            if (username && password) {
                socket.emit('login', { username, password });
            }
        });

        socket.on('auth error', function(msg) {
            authMessage.textContent = msg;
            authMessage.style.color = 'red';
        });

        socket.on('auth message', function(msg) {
            authMessage.textContent = msg;
            authMessage.style.color = 'green';
        });

        socket.on('auth success', function(data) {
            currentUsername = data.username;
            authForm.classList.add('hidden');
            chatForm.classList.remove('hidden');
            inputChatUsername.value = currentUsername;
            
            authMessage.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUsername}!`;
            authMessage.style.color = 'blue';

            socket.emit('authenticate', currentUsername);
        });
        
        // --- –õ–æ–≥–∏–∫–∞ –ß–∞—Ç–∞ ---
        
        function displayMessage(data) {
            const item = document.createElement('li');
            const sender = data.sender;
            const msg = data.msg;
            
            if (data.fileData) {
                const img = document.createElement('img');
                img.src = data.fileData; 
                
                item.innerHTML = `<strong>${sender}:</strong> `;
                item.appendChild(img);
                
                if (msg) {
                     const textNode = document.createElement('p');
                     textNode.textContent = msg;
                     item.appendChild(textNode);
                }
                
            } else if (msg) {
                item.innerHTML = `<strong>${sender}:</strong> ${msg}`;
            }
            
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const message = inputMessage.value.trim();
            const receiver = inputReceiver.value.trim(); 
            const file = fileInput.files[0]; 

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result; 
                    
                    const data = {
                        sender: currentUsername,
                        receiver: receiver || null, 
                        msg: message || null, 
                        fileData: fileData,  
                        fileName: file.name
                    };
                    
                    socket.emit('chat message', data); 
                    fileInput.value = ''; 
                    inputMessage.value = ''; 
                    inputReceiver.value = ''; 
                };
                reader.readAsDataURL(file); 
                
            } else if (message && currentUsername) {
                const data = {
                    sender: currentUsername,
                    receiver: receiver || null, 
                    msg: message,
                    fileData: null 
                };
                socket.emit('chat message', data); 
                inputMessage.value = ''; 
                inputReceiver.value = ''; 
            }
        });
        
        socket.on('chat message', displayMessage);

        socket.on('history', function(history) {
            messages.innerHTML = ''; 
            history.forEach(displayMessage);
            displayMessage({ sender: '[–°–ò–°–¢–ï–ú–ê]', msg: '--- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ---' });
        });
    </script>
</body>
</html>