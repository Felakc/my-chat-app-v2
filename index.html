<!DOCTYPE html>
<html>
<head>
    <title>My Mega Chat v3</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        #auth-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        
        #sidebar { width: 300px; background: #ffffff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: #0084ff; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        #user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; }
        .user-item:hover { background: #f0f7ff; }
        .user-item input[type="checkbox"] { margin-right: 10px; cursor: pointer; }
        .user-name { flex: 1; }

        #main-chat { flex: 1; display: flex; flex-direction: column; }
        #chat-header { padding: 15px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; color: #333; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; background: #e5ddd5; }
        
        .msg { margin-bottom: 12px; padding: 8px 15px; border-radius: 18px; max-width: 60%; position: relative; font-size: 14px; line-height: 1.4; }
        .msg .sender { font-size: 10px; font-weight: bold; margin-bottom: 3px; display: block; }
        .msg.me { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        
        #input-area { padding: 15px; background: white; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        button { padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0073e6; }
        #group-btn { background: #42b72a; padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h2>–í–æ–π—Ç–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
        <input type="text" id="u-name" placeholder="–¢–≤–æ–π –Ω–∏–∫" style="margin-bottom: 10px; width: 200px;"><br>
        <input type="password" id="u-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 10px; width: 200px;"><br>
        <div>
            <button onclick="auth('login')">–í–æ–π—Ç–∏</button>
            <button onclick="auth('register')" style="background: #42b72a;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
        <p id="auth-error"></p>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            <button id="group-btn" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
        </div>
        <div id="user-list"></div>
    </div>

    <div id="main-chat">
        <div id="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–º—É –Ω–∞–ø–∏—Å–∞—Ç—å</div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="m-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="send()">üì°</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = '';
        let currentRoom = '';

        async function auth(type) {
            const username = document.getElementById('u-name').value;
            const password = document.getElementById('u-pass').value;
            if(!username) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
            
            const res = await fetch('/' + type, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                myName = username;
                document.getElementById('auth-screen').style.display = 'none';
                loadUsers();
            } else {
                document.getElementById('auth-error').innerText = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            }
        }

        async function loadUsers() {
            const res = await fetch('/users');
            const users = await res.json();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            users.forEach(user => {
                if (user.username === myName) return;
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    <input type="checkbox" class="user-select" value="${user.username}">
                    <span class="user-name" onclick="selectPrivate('${user.username}')">${user.username}</span>
                `;
                list.appendChild(div);
            });
        }

        function selectPrivate(targetUser) {
            currentRoom = [myName, targetUser].sort().join('_');
            startChat('–ß–∞—Ç —Å ' + targetUser);
        }

        function createGroup() {
            const selected = Array.from(document.querySelectorAll('.user-select:checked')).map(cb => cb.value);
            if (selected.length < 1) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞");
            
            selected.push(myName);
            currentRoom = 'group_' + selected.sort().join('-');
            startChat('–ì—Ä—É–ø–ø–∞: ' + selected.join(', '));
        }

        function startChat(title) {
            document.getElementById('chat-header').innerText = title;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join room', currentRoom);
        }

        function send() {
            const msg = document.getElementById('m-input').value;
            if (!msg || !currentRoom) return;
            socket.emit('chat message', { room: currentRoom, msg, sender: myName });
            document.getElementById('m-input').value = '';
        }

        function addMessageToWindow(data) {
            const div = document.createElement('div');
            div.className = 'msg ' + (data.sender === myName || data.username === myName ? 'me' : 'other');
            const senderName = data.sender || data.username;
            div.innerHTML = `<span class="sender">${senderName}</span>${data.msg || data.text}`;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        socket.on('chat message', (data) => addMessageToWindow(data));
        socket.on('chat history', (history) => history.forEach(addMessageToWindow));
    </script>
</body>
</html>